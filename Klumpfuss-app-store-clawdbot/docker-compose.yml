version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: clawdbot_gateway_1
      APP_PORT: 18789

  gateway:
    # Custom Clawdbot Docker image for Umbrel
    # Built from: https://github.com/harmalh/clawdbot-umbrel
    image: ghcr.io/harmalh/clawdbot-umbrel:sha256:d8d41d16a3608e53086b80c1820905b09f45842c0e4b3c2c6c3b341ffa229bba
    user: "1000:1000"
    
    environment:
      # Pass Umbrel's app password as the gateway token
      # Users can copy this from Umbrel UI to authenticate in Control UI
      CLAWDBOT_GATEWAY_TOKEN: "${APP_PASSWORD}"
      
      # Data directories (must match Dockerfile paths)
      CLAWDBOT_STATE_DIR: /data/.clawdbot
      CLAWDBOT_WORKSPACE_DIR: /data/clawd
      CLAWDBOT_LOG_DIR: /data/logs
      
      # Node environment
      NODE_ENV: production
      
      # Home directory (matches Dockerfile user)
      HOME: /home/node
    
    volumes:
      # Persistent data directory - all Clawdbot state survives container updates
      - "${APP_DATA_DIR}/data:/data"
    
    restart: on-failure
    
    # Use init for proper signal handling (PID 1 zombie reaping)
    init: true
    
    # Healthcheck disabled for Umbrel:
    # - Umbrel's app_proxy service handles health monitoring
    # - Docker healthchecks can cause lock conflicts with gateway lock files
    # - The /health endpoint is still available for manual checks via app_proxy
    
    # Stop gracefully
    stop_grace_period: 30s
